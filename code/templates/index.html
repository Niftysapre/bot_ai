{% extends "base.html" %}

{% block title %}–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è{% endblock %}

{% block header %}–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è{% endblock %}

{% block content %}
    <!-- –§–æ—Ä–º–∞ –ø–æ–∏—Å–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ -->
    <form method="get" action="{{ url_for('index') }}" class="row g-3 mb-4">
        <div class="col-md-4">
            <input type="text" name="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –≤–æ–ø—Ä–æ—Å–∞–º" class="form-control" 
                   value="{{ request.args.get('search', '') }}">
        </div>
        <div class="col-md-3">
            <select name="status" class="form-select">
                <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                <option value="–≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ" {% if request.args.get('status') == '–≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ' %}selected{% endif %}>–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</option>
                <option value="–æ—Ç–≤–µ—á–µ–Ω" {% if request.args.get('status') == '–æ—Ç–≤–µ—á–µ–Ω' %}selected{% endif %}>–û—Ç–≤–µ—á–µ–Ω</option>
            </select>
        </div>
        <div class="col-md-3">
            <select name="priority" class="form-select">
                <option value="">–í—Å–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã</option>
                <option value="1" {% if request.args.get('priority') == '1' %}selected{% endif %}>üü¢ –ù–∏–∑–∫–∏–π</option>
                <option value="2" {% if request.args.get('priority') == '2' %}selected{% endif %}>üü° –°—Ä–µ–¥–Ω–∏–π</option>
                <option value="3" {% if request.args.get('priority') == '3' %}selected{% endif %}>üî¥ –í—ã—Å–æ–∫–∏–π</option>
            </select>
        </div>
        <div class="col-md-2 d-flex">
            <button type="submit" class="btn btn-primary flex-grow-1">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary ms-2" title="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã">
                <i class="fas fa-redo"></i>
            </a>
        </div>
    </form>

    <!-- –¢–∞–±–ª–∏—Ü–∞ —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ -->
    <div class="table-responsive">
        <table class="table table-hover">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                    <th>–í–æ–ø—Ä–æ—Å</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for question in questions %}
                <tr>
                    <td>{{ question.id }}</td>
                    <td>{{ question.user_id if question.user_id else '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π' }}</td>
                    <td>{{ question.question }}</td>
                    <td>
                        {% if question.status == '–æ—Ç–≤–µ—á–µ–Ω' %}
                            <span class="badge bg-success">–û—Ç–≤–µ—á–µ–Ω</span>
                        {% else %}
                            <span class="badge bg-warning">–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if question.priority == 1 %}
                            <span class="text-success">üü¢ –ù–∏–∑–∫–∏–π</span>
                        {% elif question.priority == 2 %}
                            <span class="text-warning">üü° –°—Ä–µ–¥–Ω–∏–π</span>
                        {% else %}
                            <span class="text-danger">üî¥ –í—ã—Å–æ–∫–∏–π</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="btn-group">
                            <a href="{{ url_for('edit_question', question_id=question.id) }}" 
                               class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-edit"></i>
                            </a>
                            {% if current_user.role in ['moderator','admin', 'superadmin'] %}
                            <form action="{{ url_for('archive_question', question_id=question.id) }}"
                                  method="POST" style="display: inline;">
                                <button type="submit" class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-archive"></i>
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
    {% set base_args = request.args.to_dict() %}
    <nav aria-label="–ü–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è">
      <ul class="pagination justify-content-center">
        {% if page > 1 %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('index', **(base_args|combine({'page': page-1}))) }}">–ü—Ä–µ–¥—ã–¥—É—â–∞—è</a>
        </li>
        {% endif %}
        {% for p in range(1, total_pages + 1) %}
        <li class="page-item {% if p == page %}active{% endif %}">
          <a class="page-link" href="{{ url_for('index', **(base_args|combine({'page': p}))) }}">{{ p }}</a>
        </li>
        {% endfor %}
        {% if page < total_pages %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('index', **(base_args|combine({'page': page+1}))) }}">–°–ª–µ–¥—É—é—â–∞—è</a>
        </li>
        {% endif %}
      </ul>
    </nav>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö -->
    <script>
        const lastCount = {{ questions|length }};
        
        // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
        const checkForNewQuestions = async () => {
            try {
                const response = await fetch("{{ url_for('questions_json') }}");
                if (!response.ok) {
                    throw new Error("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
                }
                const data = await response.json();
                if (data.length > lastCount) {
                    location.reload();
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –Ω–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤:", error);
            }
        };
        
        // –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
        setInterval(checkForNewQuestions, 10000);
    </script>
{% endblock %}
